{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/model.schema.json",
  "title": "DuckCodeModeling YAML v2",
  "type": "object",
  "required": [
    "model",
    "entities"
  ],
  "additionalProperties": false,
  "properties": {
    "model": {
      "type": "object",
      "required": [
        "name",
        "version",
        "domain",
        "owners",
        "state"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "spec_version": {
          "type": "integer",
          "enum": [1, 2],
          "default": 2
        },
        "version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
        },
        "domain": {
          "type": "string",
          "minLength": 1
        },
        "owners": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$"
          }
        },
        "state": {
          "type": "string",
          "enum": [
            "draft",
            "approved",
            "deprecated"
          ]
        },
        "layer": {
          "type": "string",
          "enum": [
            "source",
            "transform",
            "report"
          ],
          "description": "Logical modeling layer for end-to-end workflows."
        },
        "description": {
          "type": "string"
        },
        "imports": {
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/$defs/import_ref"
          },
          "description": "Cross-model imports for multi-file projects"
        }
      }
    },
    "entities": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/entity"
      }
    },
    "relationships": {
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/relationship"
      }
    },
    "indexes": {
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/index"
      }
    },
    "governance": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "classification": {
          "type": "object",
          "additionalProperties": {
            "type": "string",
            "enum": [
              "PUBLIC",
              "INTERNAL",
              "CONFIDENTIAL",
              "PII",
              "PCI",
              "PHI"
            ]
          }
        },
        "stewards": {
          "type": "object",
          "additionalProperties": {
            "type": "string",
            "pattern": "^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$"
          }
        },
        "retention": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "period": {
              "type": "string"
            },
            "policy": {
              "type": "string"
            }
          }
        }
      }
    },
    "glossary": {
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/glossary_term"
      }
    },
    "rules": {
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/rule"
      }
    },
    "metrics": {
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/metric"
      },
      "description": "Reporting metric contracts with explicit grain and dimensions."
    },
    "display": {
      "type": "object"
    }
  },
  "$defs": {
    "entity": {
      "type": "object",
      "required": [
        "name",
        "type",
        "fields"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[A-Z][A-Za-z0-9]*$"
        },
        "type": {
          "type": "string",
          "enum": [
            "table",
            "view",
            "materialized_view",
            "external_table",
            "snapshot",
            "fact_table",
            "dimension_table",
            "bridge_table"
          ]
        },
        "description": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "schema": {
          "type": "string",
          "description": "Database schema or dataset name"
        },
        "database": {
          "type": "string",
          "description": "Database or catalog name"
        },
        "physical_name": {
          "type": "string",
          "minLength": 1,
          "description": "Physical warehouse object name to use when generating SQL (e.g., FCT_PLAYER_PERFORMANCE)."
        },
        "subject_area": {
          "type": "string",
          "description": "Logical domain grouping for diagrams"
        },
        "owner": {
          "type": "string",
          "description": "Entity-level owner email or team"
        },
        "grain": {
          "type": "array",
          "minItems": 1,
          "description": "Declared uniqueness grain for the entity (field names).",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$"
          }
        },
        "sla": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "freshness": {
              "type": "string",
              "description": "Max acceptable data staleness e.g. 24h, 1d"
            },
            "quality_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Target quality score percentage"
            }
          }
        },
        "scd_type": {
          "type": "integer",
          "enum": [1, 2, 3],
          "description": "Slowly Changing Dimension type (1=overwrite, 2=history rows, 3=add column). Only valid on dimension_table entities."
        },
        "natural_key": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "The business key field name for dimension_table entities (used for SCD matching)."
        },
        "surrogate_key": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "The auto-generated surrogate primary key field name for SCD2 dimensions."
        },
        "conformed": {
          "type": "boolean",
          "description": "True if this dimension is shared (conformed) across multiple fact tables."
        },
        "dimension_refs": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z][A-Za-z0-9]*$"
          },
          "description": "List of dimension entity names this fact table references (PascalCase). Drives star schema layout and validation."
        },
        "fields": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/field"
          }
        }
      }
    },
    "field": {
      "type": "object",
      "required": [
        "name",
        "type"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "type": {
          "type": "string",
          "minLength": 1
        },
        "nullable": {
          "type": "boolean"
        },
        "primary_key": {
          "type": "boolean"
        },
        "unique": {
          "type": "boolean"
        },
        "foreign_key": {
          "type": "boolean",
          "description": "Marks this field as a foreign key"
        },
        "description": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "default": {
          "description": "Default value for the column",
          "type": ["string", "number", "boolean", "null"]
        },
        "check": {
          "type": "string",
          "description": "Check constraint expression"
        },
        "computed": {
          "type": "boolean",
          "description": "Whether this is a computed/virtual column"
        },
        "computed_expression": {
          "type": "string",
          "description": "SQL expression for computed columns"
        },
        "sensitivity": {
          "type": "string",
          "enum": [
            "public",
            "internal",
            "confidential",
            "restricted"
          ],
          "description": "Field-level data sensitivity classification"
        },
        "examples": {
          "type": "array",
          "items": {
            "type": ["string", "number", "boolean", "null"]
          },
          "description": "Example values for documentation"
        },
        "deprecated": {
          "type": "boolean",
          "description": "Whether this field is deprecated"
        },
        "deprecated_message": {
          "type": "string",
          "description": "Migration guidance for deprecated fields"
        }
      }
    },
    "relationship": {
      "type": "object",
      "required": [
        "name",
        "from",
        "to",
        "cardinality"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "from": {
          "type": "string",
          "pattern": "^[A-Z][A-Za-z0-9]*\\.[a-z][a-z0-9_]*$"
        },
        "to": {
          "type": "string",
          "pattern": "^[A-Z][A-Za-z0-9]*\\.[a-z][a-z0-9_]*$"
        },
        "cardinality": {
          "type": "string",
          "enum": [
            "one_to_one",
            "one_to_many",
            "many_to_one",
            "many_to_many"
          ]
        },
        "on_delete": {
          "type": "string",
          "enum": [
            "restrict",
            "cascade",
            "set_null",
            "no_action"
          ]
        },
        "on_update": {
          "type": "string",
          "enum": [
            "restrict",
            "cascade",
            "set_null",
            "no_action"
          ]
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the relationship"
        },
        "inferred": {
          "type": "boolean",
          "description": "True when relationship was inferred by a connector (not explicitly defined)."
        }
      }
    },
    "index": {
      "type": "object",
      "required": [
        "name",
        "entity",
        "fields"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "entity": {
          "type": "string",
          "pattern": "^[A-Z][A-Za-z0-9]*$"
        },
        "fields": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$"
          }
        },
        "unique": {
          "type": "boolean",
          "default": false
        },
        "type": {
          "type": "string",
          "enum": [
            "btree",
            "hash",
            "gin",
            "gist",
            "brin"
          ],
          "default": "btree"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "glossary_term": {
      "type": "object",
      "required": [
        "term",
        "definition"
      ],
      "additionalProperties": false,
      "properties": {
        "term": {
          "type": "string",
          "minLength": 1
        },
        "abbreviation": {
          "type": "string"
        },
        "definition": {
          "type": "string",
          "minLength": 1
        },
        "owner": {
          "type": "string"
        },
        "related_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z][A-Za-z0-9]*\\.[a-z][a-z0-9_]*$"
          }
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "import_ref": {
      "type": "object",
      "required": [
        "model"
      ],
      "additionalProperties": false,
      "properties": {
        "model": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Name of the model to import (matches the model.name field in the target file)"
        },
        "alias": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Short alias for referencing imported entities (e.g. alias.Entity.field)"
        },
        "entities": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z][A-Za-z0-9]*$"
          },
          "description": "Specific entities to import. If omitted, all entities are imported."
        },
        "path": {
          "type": "string",
          "description": "Relative file path to the model file. If omitted, resolved by model name convention."
        }
      }
    },
    "rule": {
      "type": "object",
      "required": [
        "name",
        "target",
        "expression",
        "severity"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "target": {
          "type": "string",
          "pattern": "^[A-Z][A-Za-z0-9]*\\.[a-z][a-z0-9_]*$"
        },
        "expression": {
          "type": "string",
          "minLength": 1
        },
        "severity": {
          "type": "string",
          "enum": [
            "info",
            "warn",
            "error"
          ]
        }
      }
    },
    "metric": {
      "type": "object",
      "required": [
        "name",
        "entity",
        "expression",
        "aggregation",
        "grain"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "entity": {
          "type": "string",
          "pattern": "^[A-Z][A-Za-z0-9]*$"
        },
        "description": {
          "type": "string"
        },
        "expression": {
          "type": "string",
          "minLength": 1
        },
        "aggregation": {
          "type": "string",
          "enum": [
            "sum",
            "count",
            "count_distinct",
            "avg",
            "min",
            "max",
            "custom"
          ]
        },
        "grain": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$"
          }
        },
        "dimensions": {
          "type": "array",
          "default": [],
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$"
          }
        },
        "time_dimension": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "owner": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "deprecated": {
          "type": "boolean",
          "description": "Whether this metric is deprecated."
        },
        "deprecated_message": {
          "type": "string",
          "description": "Migration guidance for deprecated metrics."
        }
      }
    }
  }
}
